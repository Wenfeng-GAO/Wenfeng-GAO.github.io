<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Coroutine With Gevent - Je pense donc je suis</title>
  <meta property="og:title" content="Coroutine With Gevent" />
  <meta name="twitter:title" content="Coroutine With Gevent" />
  <meta name="description" content="背景 工作中用到gevent。
 gevent是一个基于libev的并发库。它为各种并发和网络相关的任务提供了整洁的API。
 使用过程中，带着某些问题阅读了一部分源码，现在做一下总结与分享。
协程 Python通过yield与generator，能实现coroutine。举个栗子(更多更详细的例子请 参考this awesome presentation)：
&gt;&gt;&gt; def grep(pattern): ... print &quot;Looking for %s&quot; % pattern ... while True: ... line = (yield) ... if pattern in line: ... print line ... &gt;&gt;&gt; g = grep(&quot;python&quot;) &gt;&gt;&gt; g.next() Looking for python &gt;&gt;&gt; g.send(&quot;hello world&quot;) &gt;&gt;&gt; g.send(&quot;python generators rock!&quot;) python generators rock! &gt;&gt;&gt;  原本以为gevent会是对yield一些封装，了解后知道，在gevent里面，上下文切换通过 yielding来完成的，但其用到的主要模式是Greenlet， Greenlet是以C扩展模块形式接入Python的轻量级协程。Greenlet全部运行在主程序操作系统 的内部，但它们被协作式地调度。在任何时刻，只有一个协程在运行。
Greenlet 对于Greenlet，暂且不多说， 通过阅读官网的API，我们知道其主要是通过switch这个 方法来实现跳转的，switch如何实现的暂不做讨论，先贴上官网的例子混个脸熟：
from greenlet import greenlet def test1(): print 12 gr2.">
  <meta property="og:description" content="背景 工作中用到gevent。
 gevent是一个基于libev的并发库。它为各种并发和网络相关的任务提供了整洁的API。
 使用过程中，带着某些问题阅读了一部分源码，现在做一下总结与分享。
协程 Python通过yield与generator，能实现coroutine。举个栗子(更多更详细的例子请 参考this awesome presentation)：
&gt;&gt;&gt; def grep(pattern): ... print &quot;Looking for %s&quot; % pattern ... while True: ... line = (yield) ... if pattern in line: ... print line ... &gt;&gt;&gt; g = grep(&quot;python&quot;) &gt;&gt;&gt; g.next() Looking for python &gt;&gt;&gt; g.send(&quot;hello world&quot;) &gt;&gt;&gt; g.send(&quot;python generators rock!&quot;) python generators rock! &gt;&gt;&gt;  原本以为gevent会是对yield一些封装，了解后知道，在gevent里面，上下文切换通过 yielding来完成的，但其用到的主要模式是Greenlet， Greenlet是以C扩展模块形式接入Python的轻量级协程。Greenlet全部运行在主程序操作系统 的内部，但它们被协作式地调度。在任何时刻，只有一个协程在运行。
Greenlet 对于Greenlet，暂且不多说， 通过阅读官网的API，我们知道其主要是通过switch这个 方法来实现跳转的，switch如何实现的暂不做讨论，先贴上官网的例子混个脸熟：
from greenlet import greenlet def test1(): print 12 gr2.">
  <meta name="twitter:description" content="背景 工作中用到gevent。
 gevent是一个基于libev的并发库。它为各种并发和网络相关的任务提供了整洁的API。
 使用过程中，带着某些问题阅读了一部分源码，现在做一下总结与分享。
协程 Python通过yield与generator，能实现coroutine。举个栗子(更多更详细的例子请 参考this awesome presentation)：
&gt;&gt;&gt; def …">
  <meta name="author" content="Wenfeng Gao"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Je pense donc je suis",
    
    "url": "https://wenfeng-gao.github.io/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https://wenfeng-gao.github.io/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https://wenfeng-gao.github.io/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https://wenfeng-gao.github.io/post/coroutine-with-gevent/",
          "name": "Coroutine with gevent"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Wenfeng Gao"
  },
  "headline": "Coroutine With Gevent",
  "description" : "背景 工作中用到gevent。
 gevent是一个基于libev的并发库。它为各种并发和网络相关的任务提供了整洁的API。
 使用过程中，带着某些问题阅读了一部分源码，现在做一下总结与分享。
协程 Python通过yield与generator，能实现coroutine。举个栗子(更多更详细的例子请 参考this awesome presentation)：
&amp;gt;&amp;gt;&amp;gt; def grep(pattern): ... print &amp;quot;Looking for %s&amp;quot; % pattern ... while True: ... line = (yield) ... if pattern in line: ... print line ... &amp;gt;&amp;gt;&amp;gt; g = grep(&amp;quot;python&amp;quot;) &amp;gt;&amp;gt;&amp;gt; g.next() Looking for python &amp;gt;&amp;gt;&amp;gt; g.send(&amp;quot;hello world&amp;quot;) &amp;gt;&amp;gt;&amp;gt; g.send(&amp;quot;python generators rock!&amp;quot;) python generators rock! &amp;gt;&amp;gt;&amp;gt;  原本以为gevent会是对yield一些封装，了解后知道，在gevent里面，上下文切换通过 yielding来完成的，但其用到的主要模式是Greenlet， Greenlet是以C扩展模块形式接入Python的轻量级协程。Greenlet全部运行在主程序操作系统 的内部，但它们被协作式地调度。在任何时刻，只有一个协程在运行。
Greenlet 对于Greenlet，暂且不多说， 通过阅读官网的API，我们知道其主要是通过switch这个 方法来实现跳转的，switch如何实现的暂不做讨论，先贴上官网的例子混个脸熟：
from greenlet import greenlet def test1(): print 12 gr2.",
  "inLanguage" : "en",
  "wordCount": 839,
  "datePublished" : "2018-02-21T18:24:14",
  "dateModified" : "2018-02-21T18:24:14",
  "image" : "https://wenfeng-gao.github.io/img/avatar-icon.png",
  "keywords" : [ "python, coroutine" ],
  "mainEntityOfPage" : "https://wenfeng-gao.github.io/post/coroutine-with-gevent/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https://wenfeng-gao.github.io/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https://wenfeng-gao.github.io/img/avatar-icon.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Coroutine With Gevent" />
<meta property="og:description" content="背景 工作中用到gevent。
 gevent是一个基于libev的并发库。它为各种并发和网络相关的任务提供了整洁的API。
 使用过程中，带着某些问题阅读了一部分源码，现在做一下总结与分享。
协程 Python通过yield与generator，能实现coroutine。举个栗子(更多更详细的例子请 参考this awesome presentation)：
&gt;&gt;&gt; def grep(pattern): ... print &quot;Looking for %s&quot; % pattern ... while True: ... line = (yield) ... if pattern in line: ... print line ... &gt;&gt;&gt; g = grep(&quot;python&quot;) &gt;&gt;&gt; g.next() Looking for python &gt;&gt;&gt; g.send(&quot;hello world&quot;) &gt;&gt;&gt; g.send(&quot;python generators rock!&quot;) python generators rock! &gt;&gt;&gt;  原本以为gevent会是对yield一些封装，了解后知道，在gevent里面，上下文切换通过 yielding来完成的，但其用到的主要模式是Greenlet， Greenlet是以C扩展模块形式接入Python的轻量级协程。Greenlet全部运行在主程序操作系统 的内部，但它们被协作式地调度。在任何时刻，只有一个协程在运行。
Greenlet 对于Greenlet，暂且不多说， 通过阅读官网的API，我们知道其主要是通过switch这个 方法来实现跳转的，switch如何实现的暂不做讨论，先贴上官网的例子混个脸熟：
from greenlet import greenlet def test1(): print 12 gr2.">
<meta property="og:image" content="https://wenfeng-gao.github.io/img/avatar-icon.png" />
<meta property="og:url" content="https://wenfeng-gao.github.io/post/coroutine-with-gevent/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Je pense donc je suis" />
  <meta name="twitter:title" content="Coroutine With Gevent" />
  <meta name="twitter:description" content="背景 工作中用到gevent。
 gevent是一个基于libev的并发库。它为各种并发和网络相关的任务提供了整洁的API。
 使用过程中，带着某些问题阅读了一部分源码，现在做一下总结与分享。
协程 Python通过yield与generator，能实现coroutine。举个栗子(更多更详细的例子请 参考this awesome presentation)：
&gt;&gt;&gt; def …">
  <meta name="twitter:image" content="https://wenfeng-gao.github.io/img/avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <link href='https://wenfeng-gao.github.io/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="https://wenfeng-gao.github.io/img/avatar-icon.png" />
  <meta name="twitter:image" content="https://wenfeng-gao.github.io/img/avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <meta property="og:url" content="https://wenfeng-gao.github.io/post/coroutine-with-gevent/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Je pense donc je suis" />

  <meta name="generator" content="Hugo 0.54.0" />
  <link rel="alternate" href="https://wenfeng-gao.github.io/index.xml" type="application/rss+xml" title="Je pense donc je suis">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://wenfeng-gao.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://wenfeng-gao.github.io/css/highlight.min.css" /><link rel="stylesheet" href="https://wenfeng-gao.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



    <script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-92434611-1', 'auto');
  ga('send', 'pageview');
</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?2394a408cca2a9e611801f76b5dc0267";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>

  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://wenfeng-gao.github.io/">Je pense donc je suis</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/page/about/">About</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Je pense donc je suis" href="https://wenfeng-gao.github.io/">
            <img class="avatar-img" src="https://wenfeng-gao.github.io/img/avatar-icon.png" alt="Je pense donc je suis" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Coroutine With Gevent</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on February 21, 2018
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;4&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;839&nbsp;words
  
  
    &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Wenfeng Gao
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        

<h3 id="背景">背景</h3>

<p>工作中用到gevent。</p>

<blockquote>
<p>gevent是一个基于libev的并发库。它为各种并发和网络相关的任务提供了整洁的API。</p>
</blockquote>

<p>使用过程中，带着某些问题阅读了一部分源码，现在做一下总结与分享。</p>

<h3 id="协程">协程</h3>

<p>Python通过<code>yield</code>与<code>generator</code>，能实现<code>coroutine</code>。举个栗子(更多更详细的例子请
参考<a href="http://www.dabeaz.com/coroutines/Coroutines.pdf">this awesome presentation</a>)：</p>

<pre><code class="language-python">&gt;&gt;&gt; def grep(pattern):
...     print &quot;Looking for %s&quot; % pattern
...     while True:
...         line = (yield)
...         if pattern in line:
...             print line
...
&gt;&gt;&gt; g = grep(&quot;python&quot;)
&gt;&gt;&gt; g.next()
Looking for python
&gt;&gt;&gt; g.send(&quot;hello world&quot;)
&gt;&gt;&gt; g.send(&quot;python generators rock!&quot;)
python generators rock!
&gt;&gt;&gt;
</code></pre>

<p>原本以为gevent会是对<code>yield</code>一些封装，了解后知道，在gevent里面，上下文切换通过
yielding来完成的，但其用到的主要模式是Greenlet，
Greenlet是以C扩展模块形式接入Python的轻量级协程。Greenlet全部运行在主程序操作系统
的内部，但它们被协作式地调度。<strong>在任何时刻，只有一个协程在运行。</strong></p>

<h4 id="greenlet">Greenlet</h4>

<p>对于<a href="http://greenlet.readthedocs.io/en/latest/">Greenlet</a>，暂且不多说，
通过阅读官网的API，我们知道其主要是通过<code>switch</code>这个
方法来实现跳转的，<code>switch</code>如何实现的暂不做讨论，先贴上官网的例子混个脸熟：</p>

<pre><code class="language-python">from greenlet import greenlet

def test1():
    print 12
    gr2.switch()
    print 34

def test2():
    print 56
    gr1.switch()
    print 78

gr1 = greenlet(test1)
gr2 = greenlet(test2)
gr1.switch()
</code></pre>

<h3 id="问题">问题</h3>

<p>使用gevent最基本的用法就是<code>spawn</code>与<code>joinall</code>了，贴一个
<a href="http://www.gevent.org/intro.html#example">官网的例子</a>：</p>

<pre><code class="language-python">&gt;&gt;&gt; import gevent
&gt;&gt;&gt; from gevent import socket
&gt;&gt;&gt; urls = ['www.google.com', 'www.example.com', 'www.python.org']
&gt;&gt;&gt; jobs = [gevent.spawn(socket.gethostbyname, url) for url in urls]
&gt;&gt;&gt; gevent.joinall(jobs, timeout=2)
&gt;&gt;&gt; [job.value for job in jobs]
['74.125.79.106', '208.77.188.166', '82.94.164.162']
</code></pre>

<p>主要让我困扰的是官网对于这段代码的描述:
<em>After the jobs have been spawned, gevent.joinall() waits for them to complete, allowing up to 2 seconds&hellip;</em></p>

<p>感觉上是<code>gevent.spawn(func)</code>时，<code>func</code>就已经被调用，而<code>joinall</code>只是为了等待所有
<code>func</code>结束并返回结果。</p>

<p>然后我做了个小实验：</p>

<pre><code class="language-python">&gt;&gt;&gt; import gevent
&gt;&gt;&gt; def foo():
...     print &quot;Foo&quot;
...
&gt;&gt;&gt; def bar():
...     print &quot;Bar&quot;
...
&gt;&gt;&gt; g = gevent.spawn(foo)
&gt;&gt;&gt; g = gevent.spawn(bar)
&gt;&gt;&gt; g.ready()
()
&gt;&gt;&gt; gevent.joinall([g])
Foo
Bar
[&lt;Greenlet at 0x10c2e4eb0&gt;]
&gt;&gt;&gt; g.ready()
True
&gt;&gt;&gt;
# `ready()` Return a true value if and only if the greenlet has finished execution.
</code></pre>

<p>发现执行<code>joinall</code>之前，<code>g</code>一直是<code>not finished</code>的状态, <code>foo</code>, <code>bar</code>也没有输出任何
东西，直到执行了<code>joinall</code>，所以我猜测<code>spawn</code>并不会开
始执行<code>func</code>，在<code>joinall</code>时，会以协程的方式来调用<code>func</code>。
带着这个问题，去翻源码寻找答案。</p>

<h3 id="code-of-gevent">Code of gevent</h3>

<p><code>gevent/greenlet.py</code></p>

<pre><code class="language-python">
    @classmethod
    def spawn(cls, *args, **kwargs):
        &quot;&quot;&quot;
        Create a new :class:`Greenlet` object and schedule it to run ``function(*args, **kwargs)``.
        This can be used as ``gevent.spawn`` or ``Greenlet.spawn``.

        The arguments are passed to :meth:`Greenlet.__init__`.

        .. versionchanged:: 1.1b1
            If a *function* is given that is not callable, immediately raise a :exc:`TypeError`
            instead of spawning a greenlet that will raise an uncaught TypeError.
        &quot;&quot;&quot;
        g = cls(*args, **kwargs)
        g.start()
        return g

    def start(self):
        &quot;&quot;&quot;Schedule the greenlet to run in this loop iteration&quot;&quot;&quot;
        if self._start_event is None:
            self._start_event = self.parent.loop.run_callback(self.switch)
</code></pre>

<p>从这里可以看出，<code>spawn</code>主要以<code>func</code>为参数，生成了一个<code>Greenlet</code>对象，<code>Greenlet</code>
对象是<code>greenlet</code>的封装，然后执行了<code>start</code>方法。</p>

<p>在<code>start</code>方法中直接调用了父类<code>greenlet
</code>库中的方法，我看了半天并没有理出头绪，线索中断了。于是去看<code>joinall</code>碰碰运气。</p>

<p><code>gevent/greenlet.py</code></p>

<pre><code class="language-python">
def joinall(greenlets, timeout=None, raise_error=False, count=None):
    &quot;&quot;&quot;
    Wait for the ``greenlets`` to finish.

    :param greenlets: A sequence (supporting :func:`len`) of greenlets to wait for.
    :keyword float timeout: If given, the maximum number of seconds to wait.
    :return: A sequence of the greenlets that finished before the timeout (if any)
        expired.
    &quot;&quot;&quot;
    if not raise_error:
        return wait(greenlets, timeout=timeout, count=count)

    done = []
    for obj in iwait(greenlets, timeout=timeout, count=count):
        if getattr(obj, 'exception', None) is not None:
            if hasattr(obj, '_raise_exception'):
                obj._raise_exception()
            else:
                raise obj.exception
        done.append(obj)
    return done
</code></pre>

<p><code>hub.py</code></p>

<pre><code class="language-python">def wait(objects=None, timeout=None, count=None):
    &quot;&quot;&quot;
    Wait for ``objects`` to become ready or for event loop to finish.

    If ``objects`` is provided, it must be a list containing objects
    implementing the wait protocol (rawlink() and unlink() methods):

    - :class:`gevent.Greenlet` instance
    - :class:`gevent.event.Event` instance
    - :class:`gevent.lock.Semaphore` instance
    - :class:`gevent.subprocess.Popen` instance

    If ``objects`` is ``None`` (the default), ``wait()`` blocks until
    the current event loop has nothing to do (or until ``timeout`` passes):

    - all greenlets have finished
    - all servers were stopped
    - all event loop watchers were stopped.

    If ``count`` is ``None`` (the default), wait for all ``objects``
    to become ready.

    If ``count`` is a number, wait for (up to) ``count`` objects to become
    ready. (For example, if count is ``1`` then the function exits
    when any object in the list is ready).

    If ``timeout`` is provided, it specifies the maximum number of
    seconds ``wait()`` will block.

    Returns the list of ready objects, in the order in which they were
    ready.

    .. seealso:: :func:`iwait`
    &quot;&quot;&quot;
    if objects is None:
        return get_hub().join(timeout=timeout)
    return list(iwait(objects, timeout, count))
</code></pre>

<p><code>hub.py</code></p>

<pre><code class="language-python">def iwait(objects, timeout=None, count=None):
    &quot;&quot;&quot;
    Iteratively yield *objects* as they are ready, until all (or *count*) are ready
    or *timeout* expired.

    :param objects: A sequence (supporting :func:`len`) containing objects
        implementing the wait protocol (rawlink() and unlink()).
    :keyword int count: If not `None`, then a number specifying the maximum number
        of objects to wait for. If ``None`` (the default), all objects
        are waited for.
    :keyword float timeout: If given, specifies a maximum number of seconds
        to wait. If the timeout expires before the desired waited-for objects
        are available, then this method returns immediately.

    .. seealso:: :func:`wait`

    .. versionchanged:: 1.1a1
       Add the *count* parameter.
    .. versionchanged:: 1.1a2
       No longer raise :exc:`LoopExit` if our caller switches greenlets
       in between items yielded by this function.
    &quot;&quot;&quot;
    # QQQ would be nice to support iterable here that can be generated slowly (why?)
    if objects is None:
        yield get_hub().join(timeout=timeout)
        return

    count = len(objects) if count is None else min(count, len(objects))
    waiter = _MultipleWaiter()
    switch = waiter.switch

    if timeout is not None:
        timer = get_hub().loop.timer(timeout, priority=-1)
        timer.start(switch, _NONE)

    try:
        for obj in objects:
            obj.rawlink(switch)

        for _ in xrange(count):
            item = waiter.get()
            waiter.clear()
            if item is _NONE:
                return
            yield item
    finally:
        if timeout is not None:
            timer.stop()
        for aobj in objects:
            unlink = getattr(aobj, 'unlink', None)
            if unlink:
                try:
                    unlink(switch)
                except: # pylint:disable=bare-except
                    traceback.print_exc()
</code></pre>

<p>看到这里，终于看到了希望。
<code>Waiter</code>是对<code>greenlet</code>的<code>switch</code>, <code>throw</code>等方法一个wrapper, 而它的<code>switch</code>方法
主要也是为了调用<code>greenlet</code>的<code>switch</code>方法。</p>

<p><code>hub.py</code></p>

<pre><code class="language-python">    def switch(self, value=None):
        &quot;&quot;&quot;Switch to the greenlet if one's available. Otherwise store the value.&quot;&quot;&quot;
        greenlet = self.greenlet
        if greenlet is None:
            self.value = value
            self._exception = None
        else:
            assert getcurrent() is self.hub, &quot;Can only use Waiter.switch method from the Hub greenlet&quot;
            switch = greenlet.switch
            try:
                switch(value)
            except: # pylint:disable=bare-except
                self.hub.handle_error(switch, *sys.exc_info())
</code></pre>

<p>而<code>greenlet</code>的<code>switch</code>是做什么的自然就不用多说了。</p>

<p>当然，方法的调用过程中还有一些<code>callback</code>的用法，篇幅有限，就不讨论那么详细了。</p>

<h3 id="结论">结论</h3>

<p>在<code>gevent.joinall()</code>方法中，我们看到了协程，看到了方法是如何被实现调用与跳转的。
<code>gevent.spawn()</code>将方法包装成了<code>Greenlet</code>对象，放到了队列之中，或许有进一步的触发，
这里我并没有挖掘到太多，便不多言。</p>


        
          <div class="blog-tags">
            
              <a href="https://wenfeng-gao.github.io//tags/python/">python</a>&nbsp;
            
              <a href="https://wenfeng-gao.github.io//tags/coroutine/">coroutine</a>&nbsp;
            
          </div>
        

        

        
          
          
          <h4 class="see-also">See also</h4>
          <ul>
          
            <li><a href="/post/python-yield-keyword/">Python Yield Keyword</a></li>
          
          </ul>
          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://wenfeng-gao.github.io/post/python-yield-keyword/" data-toggle="tooltip" data-placement="top" title="Python Yield Keyword">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://wenfeng-gao.github.io/post/core-dump-file-size-limit-in-docker/" data-toggle="tooltip" data-placement="top" title="Core Dump File Size Limit in Docker">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
        
          
          <div class="disqus-comments">                  
            <button id="show-comments" class="btn btn-default" type="button">Show <span class="disqus-comment-count" data-disqus-url="https://wenfeng-gao.github.io/post/coroutine-with-gevent">comments</span></button>
            <div id="disqus_thread"></div>

            <script type="text/javascript">
              var disqus_config = function () {
              this.page.url = 'https:\/\/wenfeng-gao.github.io\/post\/coroutine-with-gevent';
            };

          </script>
          </div>
          
        
        
      

    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:elricfeng@gmail.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://plus.google.com/103999582027187063854" title="Google&#43;">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-google-plus fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/Wenfeng-GAO" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://stackoverflow.com/users/4262814/wenfeng" title="StackOverflow">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://paypal.me/elricfeng" title="PayPal">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-paypal fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            
            <a href="https://wenfeng-gao.github.io/index.xml" title="RSS">
            
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Wenfeng Gao
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2019
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://wenfeng-gao.github.io/">Je pense donc je suis</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.54.0</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://wenfeng-gao.github.io/js/main.js"></script>
<script src="https://wenfeng-gao.github.io/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script> renderMathInElement(document.body); </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script>
<script src="https://wenfeng-gao.github.io/js/load-photoswipe.js"></script>







<script type="text/javascript">
$(function(){
  $('#show-comments').on('click', function(){
    var disqus_shortname = 'https-wenfeng-gao-github-io';
      
    (function() {
      var disqus = document.createElement('script'); 
      disqus.type = 'text/javascript'; 
      disqus.async = true;
      disqus.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(disqus);
    })();
      
    $(this).hide(); 
    });
  });
      
</script>
<script id="dsq-count-scr" src="//https-wenfeng-gao-github-io.disqus.com/count.js" async></script>




  </body>
</html>

